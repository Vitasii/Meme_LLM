import gradio as gr
from PIL import Image
import os

from dotenv import load_dotenv
from openai import OpenAI
from langchain_openai import OpenAIEmbeddings
from langchain_chroma import Chroma
import re, time, json, math, threading, random
from openai import RateLimitError

load_dotenv()

CHAT_MODEL="deepseek-v3"

CHAT_MODEL2="llama-3.3-70b-instruct"

openai_api_key = os.environ.get("INFINITE_API_KEY")
openai_base_url = os.environ.get("INFINITE_BASE_URL")

client = OpenAI(api_key=openai_api_key, base_url=openai_base_url)

def get_response(prompt, model_name): 
    response = client.chat.completions.create(
        model=model_name,
        messages=[{"role": "user", "content": prompt},]
    )
    return response.choices[0].message.content

baai_embedding = OpenAIEmbeddings(
    model="BAAI/bge-m3",
    base_url=os.environ.get("SF_BASE_URL"),
    api_key=os.environ.get("SF_API_KEY"),
)

chroma_dir = "tmp/chroma_db"
docsearch_chroma = Chroma(
    embedding_function=baai_embedding,
    persist_directory=chroma_dir,
    collection_name="memes",
)

def get_image(img_path):
    if not os.path.exists(img_path):
        return None  
    try:
        with Image.open(img_path) as img:
            return img.copy()  
    except Exception as e:
        return None  

# prompt for judgement
def return_prompt(query, meme_names):
    
    prompt = f"""现在有希望找到一个meme图的询问和一批回答（以meme的文字内容为形式给出）。
    请根据以下几个维度来评估每个回答，并且根据你的评估找出一个最好的回答。

    1. 相关性: 这个回答对于询问的契合度有多高？这种契合可能需要一定的前提，如回应者的身份，或者出于某种立场。
    2. 趣味性: 这个回答是否足够新颖？是否幽默？这个回答甚至可以具有一定的冒犯性。
    3. 针对性: 这个回答是否是对于询问的场景下的针对性的回答？我们不希望回答的泛用性过强，导致可以回答很多种不同的询问

    对于每个维度，给出一个评价以及简短的解释。
    
    ############
    
    meme图的询问： {query}
    
    回答：{meme_names}
    
    ############
    
    格式要求：你应当按照meme图回答的顺序依次进行你的评价的输出，每两个meme图回答对应的输出最后需要输出一个'#'号。
    在输出的最后，给出你所选择的最好的meme的名字。
    """

    return prompt

# copied from lab6
def my_parse_judge_output(judge_output):
    # this inherited function is widely used in research repositories
    # it does some simple fixes to the output to make it a valid JSON
    try:
        # 尝试提取花括号包裹的部分
        match = re.search(r"\{.*\}", judge_output, re.DOTALL)
        if not match:
            raise ValueError("No JSON object found in the output.")
        
        json_str = match.group(0)

        # 简单修复常见 JSON 错误：缺逗号、缺括号等
        json_str = re.sub(r'("explanation"\s*:\s*"[^"]+)"\s*(")', r'\1,\2', json_str)  # 补逗号
        json_str = json_str.strip()

        # 尝试解析 JSON
        return json.loads(json_str)

    except Exception as e:
        print(f"Error parsing judge output: {e}")
        print(f"Raw output: {judge_output}")
        return {
            "相关性": {"score": 10, "explanation": "Failed to parse"},
            "趣味性": {"score": 10, "explanation": "Failed to parse"},
            "针对性": {"score": 10, "explanation": "Failed to parse"}
        }
     
def judge_meme(candidates, k, query):
    can_and_score = []
    candidate_names = []
    for meme in candidates:
        candidate_names.append(meme[1])
    judgement_str = get_response(return_prompt(query, candidate_names), CHAT_MODEL2)
    judgements = judgement_str.split('#')
    
    i = 0
    for scores in judgements:
        judgement = my_parse_judge_output(scores)
        name = candidates[i]
        print(f"judgement of {name[1]}:")
        print(judgement)
        sum_score = 1 * judgement['相关性']['score'] 
        sum_score += 1 * judgement['趣味性']['score'] 
        sum_score += 1 * judgement['针对性']['score']
        can_and_score.append((name, sum_score))
        i += 1
        
    sorted_candidates = sorted(can_and_score, key=lambda pair: pair[1], reverse=True)
    print(sorted_candidates)
    select_list = []
    for i in range(min(k, len(sorted_candidates))):
        select_list.append(sorted_candidates[i][0])
        
    return select_list
   

def find_meme(query, num_meme):

    prompt = f"""
    你将要模仿罗翔老师，他是一个法律方面的科普专家（你可以查阅相关资料了解他的说话风格，幽默，讽刺，通俗），
    现在你需要根据别人提出的问题
    产出类似风格的语句，可以考虑以下角度：
    
    1. 你可以就文本中出现的概念进行进一步解释，或者给出文本中出现的事物的更多细节。你可以进行网络搜索。 
    
    2. 你可以给出或分析文本中提到的事物产生的原因；你可以从若干个不同的角度、立场分析原因。
    
    3. 你可以给出一些应对文本中提到的事物的对策。你可以从若干个不同的事物参与主体出发，给出可能得应对策略。
    
    4. 你可以就一些文本中提到的观点或者事物进行评论或者评价。你可以从若干个不同的角度、立场（如支持、反对、中立）进行评价。
    
    ########## 
    例句（你可以模仿风格，也可以直接选取里面的句子）：237条强制猥亵罪将男性也作为被害人,2006年某地就发现了121个头骨骷髅,1997年刑法规定了盗窃、侮辱尸体罪,237条规定了猥亵类犯罪,50%以上似乎都充斥着这种虚荣,《投名状》的庞青云说自己一生如履薄冰,一个人为什么要喝多酒对狗汪汪叫,一个人心坏了,一个人肾坏了,一个人皮坏了,一个人真正的成功不是在他辉煌的时候有多么的风光,一个小学乍所写的作业,一个人肺坏了,一个尊重人性的人同样也能够,一个尊重别人的人就不会把他人,一个情人比国王大,一个智慧的人一定是一个谦卑的人,一个最重要的功课就是要学会尊重,一个情人比国王小,一个最重要的问题,一个杂志向我约稿,一个疯子在铁轨上捆了五个无辜的人,一个虚无的人会寻找虚空,一个虚空的人会不断的虚无,一天晚上喝多了,一定不要把自己排除在道德判断之外,一定会导致强者对弱者的剥削,一律可以构成猥亵儿童罪,一方面我们在批评他人过程中,一方面是视频的制作者,一旦允许突破法律语言类推适用,一本书就像一把利斧劈开我们冰封的内心,一点都不好吃,一瓶油一包盐,一种是传播淫秽物品罪,一种是功利主义,一种是道德主义,一类是传播淫秽物品类犯罪,一篇名为这个《我潜伏上海名媛群》的这篇文章,一边是一生行善但却身败名裂,一类是性犯罪,一边是坏事做尽但却流芳百世,一般认为骗没有偷,一边是一个人,一边是五个人,三个人骗烟抽,不仅会毁灭个体,不到万不得已不应轻易使用,不到万不得已不要轻易的使用,不包括男性,不喜欢国王比她小,不能够以这个盗窃、侮辱尸体罪,不少村民抵达后悲痛欲绝,不知反抗和不敢反抗,不能反抗,不能存留,不能用男性的标准来要求履行,不能被彻底物化,与自怜的内心,两百块钱你咬死他,两百块钱你咬死他_1,为什么会有许多人实施这类犯罪,为什么会愤怒,为什么总是要站在坏人的立场,为什么法律人那么较真法律语言的适用呢,为什么要行动,为什么说文人相轻啊,为什么这种恶心的案件总是会发生呢,为危险驾驶罪,乃是开启智慧的大门,也不构成编造虚假恐怖信息罪,也会毁灭社会,也偷偷地拔掉,也只是一种扬言要犯罪,也可以处5年以上15年以下有期徒刑,也在实践中会导致放纵与堕落,也存在不小的争议,也并不意味着逻辑和技巧没有意义,也是对有不良偏好者人的剥削,也有一些功利主义认为,也有基本的真假,也有很多人是按照自己的感受,也没有什么是绝对的错,也没有致命的失败,也许并不一定会有冲突,也许是构成这个侮辱尸体、尸骨、骨灰罪的,也谈不上侵权问题,习惯指责他人胆小的人可能自己也懦弱无比,习惯责备别人生活作风不好的人呢,书中自有千钟粟,事实上法治的一个重要前提就是对人性幽暗的假设,人不能是纯粹的手段,人们常说呀,亡国灭种总比做这种亡国奴要强,人可以违反道德律,人为妇人所生,人之所以不能被看作一件东西,人只能是目的,人咬狗就是新闻了,人心中的张三却是无穷的,人心隐藏着整个世界的败坏,人性的幽暗有时会让法律捉襟见肘,人总是习惯于向他人随意进行道德上的谴责,人总是习惯于向他人随意进行道德上的谴责_1,人才是自由的,人生总是充满着无数的变数,人的尸体和动物的尸体,人被彻底的工具化,什么叫哲学,今天我们想讲一个非常严肃的话题,从另外一个角度来讲,从媒体所报道的事件来说,从来都存在一定的张力,从而导致人格的分裂,从视频制作者所发布的视频来说,从而不断的助长我们的骄傲与自大,从这个角度来说,他们会遭遇挫折,从逻辑上来说,仔细思考的话,他会不会哭,他不会当在大庭广众下骂了一个女的她会不会哭,他们会遭遇苦难,他们的一生并不是平平顺顺,他们持一种相对主义的态度,他可以处拘役,他抽了一千块,他的法定刑是5年以下有期徒刑,他的法定刑最高是两年有期徒刑,他是不断周而循环,他是男性针对女性的,他认为在这个案件中很明显B是属于一个寄生物,他有可能会哭,他背后有没有令人心酸的故事,他至少涉及两类犯罪,他都有一个危害行为,他除了构成入户盗窃,他非常生气,他驾驶的是摩托车,以前只听说过美颜、变年轻的软件,以及如何以行动去改变的故事,以至于后来常被人询问,以填满自己内心的空虚与不足,但一定要注意了,以至于忘记了走出洞穴的道路,但不同的被害人在理解什么叫猥亵的时候,但不同的被害人我们在理解什么叫猥亵的时候,但不想三人成虎,但不知能否走到对岸,但习惯于用大镜头看待自己的错,但你也可以构成入户盗窃,但关键在于在你挫折的时候,但其实不过成为了欲望的奴隶,但只是对你个人的一种道德义务,但只有技术而没有理想,但如果八十老翁被人P成八岁小孩,但在本案中,但对于真正的理想主义者而言,但如果他把狗砸死了或者毁坏的财物把狗咬死了,但如果你发自内心的尊重道德律,但如果把人P小P靓,但很遗憾,但很难被接受的,但无论是犯罪预备犯罪未遂,但是B的器官发育不完备,但是不允许超越语言的极限进行类推解释,但是也有学者认为,但是功利主义却不这么看,但是不得不承认女性在这个社会,但是医院就觉得不合适,但是他对着狗叫汪汪汪,但是可以肯定的是,但是你会发现,但是另外一个轨道也捆了一个无辜的人,但是可以构成盗窃罪属于入户盗窃,但是各位会发现,但是各位要注意,但是回到本案啊,但是在我们今天的骗烟暗中因为它只是一种骗啊,但是如果你看到人类的尸体,但是如果你进行切割的话,但是强一点的A94%的可能性有可能会存活,但是我必须要提醒各位的是,但是当你一旦认为生命不能进行比较,但是有人就说了,但是相比做一个虚荣的人,但是聪明人不一定有智慧,但是要看这只狗什么狗,但是请各位注意,但是这和我国的立法是不一样的,但是这里要提醒各位跟诈骗相关的一个犯罪是盗窃,但是这种案件令人感到心酸,但是这种观点很难被接受的,但是这种让人感到发笑的案件是否构成犯罪呢,但是这里面要注意一个例外,但是这里面需要注意的是,但是非功利性的阅读才能够真正的让你去意识到我们的渺小,但现在很多国家都采取了所谓的性别中立主义立法,但理想主义者不一定正直,作为一个诚实的人,但真正的理想赋予我们勇气与激情,但请你注意了,但这些东西都成为了你的养分,作为玩物,作为禁止淫秽物品的理由,作家的影子就轻易的投射到对面的阳台,你一个指头指向别人呢,你会不会扳下轨道呢,你一定不会有这种力量,你不可能如此的冷静,你主观上知道你在帮她实施性犯罪,你依然为其提供金钱的资助,你先可以读一读这本书,你可能就跟道德主义开始投怀送抱,你可能按照一般人标准只能计算他那个作业本的数额,你可能无动于衷,你四个人是一种共同犯罪行为,你学习法律就天天读法条就可以了嘛,你就为什么不能把苦难当做你人生的剧本,你才会发现我是如此的渺小,你才能够坦然的接受自己的命定,你才能够抵制成功主义的读书,你抽了一千块,你明知道他人要去实施猥亵,你是不是依然有勇气继续的前行,你是否依然有继续活下去的勇气,你望尽天涯路,你死死的掐着一个人的脖子,你比如张三在修整田地的时候,你永远无法培养你内心的这种智慧,你的影子是会吞掉你,你的性质属于盗窃数额特别巨大,你的目的就成功了,你的菜单是什么你记不住了,你要为你的偏见付出代价,你要出名,你要去阅读这些作品,你看到没有,你等着我一定要杀了你你等着你等着你等着,你等着我一定要杀了你你等着你等着你等着_1,你要成功,你要真实吧,你觉得你是自由的,你觉得呢,你越是严厉的批评,你越阅读你越站在人类知识的巅峰,偷的东西虽然不值钱,你都会有辉煌的成就,依然在很多时候处于弱势的地位,侵犯了肖像权,偷了有价值的财物,傲慢,像数学运算一样,儿童是不满14周岁的,公共场所当众来猥亵,六十个人呢每人这个一百块钱呢拼租一天的法拉利,六十个人呢每人这个一百块钱呢拼租一天的法拉利_1,共同犯罪的特征是部分行为是整体责任,关于骨灰是否属于尸体,关心和更多的关爱,其实依然可以归结为对人的尊重,其实也常有发生,其实也是对这个曾经活着的人的尊重,其实你会发现很多时候阅读具有一种悖论性,其实只是虚无主义的一种体现,其实同学们从小到大呢,其实很多书是没有必要读,其实我们会发现这个社会弥漫的都是成功主义的价值观,其实这个童话是写给成人看的,其实道德主义和功利主义,再后来呢,写了洋洋洒洒数千字,凭什么要接受一个错误,刑法理论有一种共同犯罪的规定,刑法中有一个多次盗窃的规定,刑法中有一个罪名叫故意毁坏财物罪,判处到死刑,刑法是最后法,刑法规定入户盗窃入户盗窃并不需要数额较大,刚才我们说过,别人晒的香肠虽然香肠价值不大呀,制造条件,功利的计算与算计原本就是同义词,医生说小伙子身体怎么样,单纯的点击淫秽视频,单纯的观看淫秽视频,危险驾驶罪,危险驾驶罪要达到醉驾的标准,即便天塌下来,即便我们跟纳粹战斗到底,即便每次都偷了十几块钱,却在名利的薄冰上流连忘返,却很容易忽视自己的问题,却很少呢去反思自己,去真正的爱你周围那些具体的人,去面对人生的大风大浪,又包括女童,又被割下飞去如影,反而会使得我们对身边的具体人,反而可以沽名钓誉,发现这是数名农民盗墓之后,取出转卖,另一方面是围观者,只是一种口舌之快嘛,又可以是女性,只有女性才是被害者,只有感受,只有理想没有技术,只有理想没有技术_1,只有观点,只要两年内三次盗窃,只要你入户了,只有诠释,只有非功利性的阅读,可以处三年以下有期徒刑、拘役或者管制,只能是目的,只要理想依然高悬于空,可以以强制猥亵罪或者强奸罪,可能值五十六十块钱,可以看部影片叫《儿童法案》,可以直接构成故意伤害罪,可能是一次讲座,吃得苦中苦的目的是为了成为人上人,各位会发现那是牟利型的和,各大畅销书基本上都是成功学的鸡汤类读物,各种器官不正常,同时并处罚金,同时我们也会发现这么多伟大的灵魂,后来作家醒来影子不见了,后来发现这五个年轻人都是北大的高材生,后来呢又看到了很多视频,后来国王就成了一个光头,后来这个小偷非常生气,后被鉴定为人头骨,听天由命一种最好的选择,哪种选择更危险呢,哲学就是爱智慧所有的哲学,听天由命吧,和这种弱智可以进行人道毁灭,哎呀我心里很想说,唯有读书高,啊呀都会让我们觉得厌烦,啊的的确确,啪啪怕你把他删掉了,因为B已经是在对A进行谋杀,因为只有非功利性的阅读,因为传播淫秽物品牟利不仅仅是,因为只有这种非功利性的读书,因为任何人都没有权利去决定一个人的生死,因为哲学可以培养我们的世界观,因为影子长大了,因为我们不可能做到彻底的虚荣,因为我们在很多地方反复的说过,因为我们心中依然有对错的标准,因为我们知道他们活得不真实,因为我刚才说过,因为我国的传播淫秽物品罪,因为我头发本来就稀薄,因为我请到了我在b站最喜欢的老师,因为所有的虚荣其实都是在掩饰自己的缺乏,因为无论你如何立法性侵犯罪,因为按照当时的英国儿童福利法,因为是A用自己的心脏来源源不断的为B提供养分,因为最近有报道说,因为现在许许多多地方的超市都是自助购物啊,因为未成年人通常是沒有钱的,因为柏拉图就说了什么叫正义,因为认为保护儿童的权益比隐私,因为没有人有权利去剥夺他人的生命,因为禁止淫秽物品的一个重要理由,因为符合最大多数的最大利益,因为知识总是让人瞧不起的,因为说强奸罪啊,因为这不用付出任何代价,因为读书能获得知识,因为虚荣不真实,因为这不真实,因为这能够满足我们想象中的道德优越,因为道德在绝大多数情况下都是一种自律,因为那部影片让我真正的知道我们这一生要对抗的就是虚荣和虚空,因此对于每一个怀揣理想的人而言,因为这里的问题是,在一个虚无主义盛行的年代,在《理想国》中苏格拉底对充满怀疑主义的格劳孔兄弟说,在人类历史的长河中,在世界各国这一般是不构成犯罪的,在你低迷的时候,在他家有没有搜到炸弹,在刑法修正案九之前啊,在公共场所当众来发生这类的性侵行为,在危难来临的时候,在发生性关系的时候,在成功的幻境中如痴如醉,在大部分地方才能达到立案标准,在大部分地方才达到的立案标准,在我的朋友圈中,在我社会乱象的根源在我,在指责别人的过程中会获得快感,在法律上都视为不同意,在案件中,在案件中不是什么避险的问题,在父亲去世以后,在这个案件中呢,在这个案件中,在这个案件中很明显B是属于一个寄生物,坦然的接受自己的失败,墓碑被砸成碎片,外界的虚荣,增加了故意毁坏这种行为方式,大家不要认为法律概念与事实的对应关系,多有忧患,多年以前,多读读成功学不就得了吗,大家可能听过我上课举过的例子,大家觉得构不构成犯罪呢,大家觉得这合理吗,天天发表冠免堂皇之词,失去了应有的关心,女性针对男性女性针对女性都可以构成强制性交罪,女性语言声的拒绝和哭泣也要被尊重,如何去阅读一本书,如何对待有缺陷的法律,如何阅读一本书,如果一本书不能够挑战我们,如果他们会遭遇苦难,如果主体同意对他人的肖像进行篡改,如果你不做这些非功利性的阅读,如果你取出炸弹准备点,如果你不知道如何去阅读,如果你受制于个体的欲望,如果你接受的仅仅是成功主义的熏陶,如果你明知道他人要去实施性侵,如果你真的把火车站炸了,如果你觉得这个合理,如果你认为可以牺牲一个人的生命来保存五个的生命,如果你讲究道德的功利主义,如果你读书的目的只是这样一种功利性的目的的话,如果只是为了保护未成年人的话,如果女的说不要女的拒绝,如果尸体已经腐烂为尸骨,如果我们任由他长大,如果忽视行为本身的良善,如果是性侵的话,如果是猥亵的话,如果有几种加重情节可以最高,如果标准不明确,如果淫秽视频是儿童的淫秽视频,如果真的有时间,如果没有达到的话,如果硬要在打击不足和打击过度中,如果自由不加限制的话,如果读书的目的只是为了成功,如果还造成了伤害,如果这个案件发生在2015年11月1号之前,如果这只狗很便宜啊,如果这种案件发生在我国应当如何处理,如果这种行为导致了对方轻伤以上的结果,如果醉酒驾驶摩托车,孤标傲世知识让人骄傲,孤标傲世知识让人骄傲_1,孩子的母亲是不愿意切割,它值多少钱,它在不断的侵夺A的养分,它属于公共场所强奸妇女,它并不存在违反罪刑法定原则之嫌,它是正当防卫的问题,它来源于拉丁文啊,它的价值有没有达到三千块钱,它的最高刑是两年,安徒生写的《影子》,客观上你也实施了帮助行为,对不起,对世间万物呢进行诠释,对于坏人直接打击不就得了吗,对于恶搞表示同意与接受,对于没有生存价值的精神病人,对于法律人而言,对于我个人而言,对人的尊重是一种道德戒律,对于盗窃或者倾洒骨灰,对自己的父亲恨之入骨,对尸体的尊重,对孩子父母说听天由命,对此也有过激烈的争论,对错与真假都是理想起步的前提,对这个尸体进行这个侮辱,将主人取而代之,尊重自己,尤其当我们指出他人的失败叫别人无地自容_1,就不能试着改变它吗,尤其当我们指出他人的失败叫别人无地自容,就个就叫电车难题,就像无问西东所说的,就是N号房事件,就是人是有尊严的,就发布了一则,就像溺水的时候,就把这个罪名改了,就有一定的争议,属不属于本罪的对象,就是侮辱骨灰是不是犯罪,尸骨属不属于尸体,年纪小的情人不喜欢国王比她大,并要制作相应的视频,应该处无期徒刑,幸福千万家,康德说人只能是目的人不能是纯粹的手段,开题0410,张三到派出所因为派出所没有处理他的问题,就是人们有没有学会去尊重他人,就是苏格拉底所说的承认自己的无知乃是开启智慧的大门,希望法院作出裁决,异化为理想的反面,强制猥亵罪的被害人只能是妇女,强奸罪被rape这个词语呢,强制猥亵他的对象既可以是男性,弱一点的B一定会死,当人类的尊严被亵渎,当作你必须演好的一个剧本,当你在路上看到动物的尸体,当我们在别人身上发现了自己也有的缺点,当然,当然也不都是在炫耀自己的财富,当然了,当然充满着危险,强制猥亵既可以是男性,强奸罪的基本刑是三年以上十年以下有期徒刑,当然在这类案件中最突出的一个问题,当然我不是说人们不能进行道德谴责,当然我也不能说你这种观点是错误的,强烈地冒犯了公众的情感,当然刑法中还专门规定一种犯罪,当然这里面有一个突出的问题,当这种行为在刑法中应该如何评价呢,影子回来杀死了主人,影子就看到别人家的一切,往往会择为达目的不择手段,往往自己也深陷其中无力自拔,征稿的题目说社会乱象根源何在,很多东西要准备高考,很多亲朋好友都发来慰问,很多人为什么反感理想主义,很多人就会纳闷了,很可能在性方面是放纵堕落的,当然在男女交往的过程中,很多人都对理想主义不屑一顾,当然是可以论以我国刑法中所说,很多同学希望我讲一讲电车难题,当然正是考虑到有这些问题,很多人说万般皆下品,很多同学经常用这个案件来反驳我的观点,很多地方我都提过,很多时候,很多时候我们的这些哲学思考,很多男的说,忽略手段的善,很遗憾,性别中立主义的立法在很多时候只具有一种符号作用,性质恶劣,总是缩的很小很小,恶心的视频,您准备好了吗,想炸火车站,想给大家聊一聊,想象竞合从一重罪,成功主义的阅读功利主义的阅读一定会让人自高自大,我不也这么虚荣吗,我不否定有功利性的目的,我不知道这样才可以遏制你内心的知识优越感,我个人认为我们没有权利去任意剥夺他人的生命,我也不能说这是错的,我也抽了一千块,我们一般认为偷比骗可能更重一点,我们不可能做到彻底的虚假,我们不喜欢学者夸耀自己拥有多少的智慧与知识,我们不需要完美,必须以行为之善追逐结果之善,忽视道德律的约束,怎么头发全白了,我们为什么会哭泣,我们会发现,我们会如何行为,我们关于数额较大的判断标准还是一般人表准,我们为什么要读它,我们刚才看到这个案件啊,我们只需要去读慢慢的就成为了我们的养分,我们为什么要活在这个世界,我们也不喜欢权贵的炫富,我们也会在有些情况下对别人真实,我们可以获得一种自以为是的快感,我们可以为了保全别人的生命来牺牲自己,我们可能会极力的批评与论断,我们因为无知而去阅读,我们在座的每一个人终将有一天会离开这个世界,我们在座的每一个同学,我们如何去走出自己的狭隘自己的偏见,我们很习惯把自己放在道德上的制高点上,我们很多时候好读书,我们很容易轻易的对他人进行道德上的指责,我们在理解性侵的标准的时候,我们小时候经常说,我们并不需要记住那些精彩的段落,我们很容易发现别人的问题,我们更多的还有非功利性的阅读,我们必须首先问我们自己在相似的情况中,我们很容易轻易的对他人进行道德上的指责_1,我们必须首先要问我们自己在相似的情况中,我们明显就发现,我们活在这个世界的目的是什么,我们甚至听到别人夸耀自己的行善,我们生活在两个逻辑极端中,我们的读书一定有两种目的,我们的阅读永远不要只读自己喜欢读的,我们知识的想象力让我们知道,我们知道虚荣是不自恰的,我们经常像望远镜一样,我们至少希望别人对我们是真实的,我们英国可能会亡国灭种,我们要不断的阅读穷尽,我们要与他们去兑换,我们要为我们的死亡做预备,我们要去思考,我们要培育这个字,我们要读什么书呢,我们要读历史作品,我们能不能发自内心的去尊重她,我们要读哲学作品,我们要读挑战我们的书籍,我们要阅读哲学,我们要读文学作品,我们越承认自己是无知的,我们有一种道德上的义务,我们每一个人都有一个黑暗的影子,我们每个人心中都藏着一个张三,我们都不能牺牲一个无辜的人去挽救他人的生命,我只是看到的知识的惊鸿一瞥还有那么多的东西,我可以牺牲他人来保全我自己或保全另一些人的生命,我国也部分采纳了这种立法倾向,我国刑法236条规定的强奸罪,我国刑法规定的危险驾驶罪,我国的法律的经常被人批评,我就发现自己犯了一个经常犯的错误,我在大庭广众下拍了一个男生的耳光,我幻想了一下现场画面可能是这样的,我当然不希望在座的同学这一生会遭遇挫折会遭遇苦难,我想给同学们讲一讲读书的问题,我想在这个时候就不能按照男性的标准来理解,我想这种立法应当被我国所接纳,我想这至少涉及两方面的当事人,我把问题留给亲爱的同学们,我抽了一千块,我持反对态度,我是非常非常地厌恶的,我曾经认为,我有一次和我的一个朋友讨论这个案件,我痛不欲生,我的朋友的回答让我大惊失色,我的第一评价呢是虚荣,我相信绝大多数同学让你登上一个辉煌的舞台,我觉得他说的也蛮有道理的,我觉得解释还是非常非常美妙的,我本来觉得谣言不攻自破,我们除了要有功利性的阅读,我记得有一哥们到别人家发现没什么东西偷顺手偷了几根啊,我们需要的是否能够从心底发出的勇敢,我们需要需要与人类伟大的灵魂去对话,我觉得这只是逞口舌之快,我说这合适吗,我辛辛苦苦写了一篇文章,我非常喜欢魔鬼代言人,或者什么宝格丽酒店的房间四十个人呢分批依次拍照

    ##########
    文本：{query}
    
    ##########
    
    格式要求：
    
    1. 返回5句5个字以下的，5句5-10字的，5句10-15字

    2. 但是请保证格式严格为一行一句，不要有其他任何换行或者空格

    """

    num_candidate = math.ceil(num_meme / 2)
    
    response = get_response(prompt, CHAT_MODEL)
    responses = response.split('\n')
    responses = [s.strip() for s in responses if s.strip()]
    print("text responses generated:")
    print(responses)
    print("===================================")

    image_list = []
    candidate_names = []
    for text in responses:
        docs = docsearch_chroma.similarity_search(text, k=num_candidate)
        for result in docs:
            print(result)
            candidate_names.append((result.metadata['path'], result.page_content))
    print("meme candidates:")
    print(candidate_names)
    print("===================================")
    
    meme_list = judge_meme(candidate_names, num_meme, query)
    print("===================================")
    print("meme selected:")
    print(meme_list)
    print("===================================")
    image_list = []
    for meme in meme_list:
        image_path = os.path.join(meme[0], meme[1])
        image_list.append(get_image(image_path))
        
    return image_list


demo = gr.Interface(
    fn=find_meme,
    inputs=[gr.Textbox(label="query"),  
            gr.Slider(minimum=1, maximum=10, step=1, label="# of generated memes")], 
    outputs=gr.Gallery(label="generated memes"),
)

demo.launch()